# TODO: Update package pinnings in conda_build_config for every release
schema_version: 1
context:
  version: "1.53.0"
package:
  name: nvidia-dali-python
  version: ${{ version }}
source:
  - url: https://github.com/NVIDIA/DALI/archive/refs/tags/v${{ version }}.tar.gz
    sha256: ed805616a86ab4942672608c18c504d03c948d055b5d0ce56e389b15f5879b3f
    patches:
      - patches/0003-BLD-Use-shared-libtar-instead-of-static.patch
      - patches/0002-DOC-Patch-dlopen-failure-message-and-dlopen-search-p.patch
      - patches/0001-BLD-Use-CUDA-target-include-directory-to-support-cro.patch
      - patches/0004-BLD-Patch-nvcomp-search-path-and-dlopen-error-messag.patch
      - patches/0007-BLD-Remove-CUDA-arch-validation.patch
      - patches/0001-Add-USE_PREBUILD_PYBIND11-option-to-use-system-pybin.patch
      - patches/0008-BLD-Dynamically-link-nvjpeg2k.patch
  - url: https://github.com/cocodataset/cocoapi/archive/8c9bcc3cf640524c4c20a9c40e89cb6a2f2fa0e9.tar.gz
    sha256: 4dd3450bab2287d1c1b271cf4a1420db05294194f0ad9af4e3af592d6f2b4410
    target_directory: third_party/cocoapi
  - url: https://github.com/JanuszL/ffts/archive/6ef8d818f46f679c95110ab199ae915fb04bfef5.tar.gz
    sha256: 1d157157828ce1c85d0a43a6de312ce168b3c5dc1223c6ad3f02e074c3806c15
    target_directory: third_party/ffts
build:
  number: 0
  skip:
    - cuda_compiler_version == "None"
    - win
    # - match(python, "!=3.12.*")
requirements:
  ignore_run_exports:
    by_name:
      - cuda-version
    from_package:
      - libcufft-dev
      - libcufile-dev
      - libcurand-dev
      - libnpp-dev
      - libnvjpeg-dev
      - libnvimgcodec-dev
      - if: linux and aarch64 and arm_variant_type != "tegra"
        then:
          - libnvcomp-dev
      # Added libprotobuf to pick up channel pinnings, but we use the static package
      - libprotobuf
  build:
    - ${{ compiler('cuda') }}
    - ${{ compiler('cxx') }}
    - ${{ stdlib('c') }}
    - if: linux and aarch64 and not match(cuda_compiler_version, "==None")
      then:
        - arm-variant * ${{ arm_variant_type }}
    - cmake 3.*
    - file
    - ninja
    - pkgconf
    - if: build_platform != target_platform
      then:
        - cross-python_${{ target_platform }}
        - python
        - python-clang
        - libprotobuf
        - libprotobuf-static
  host:
  # NOTE: static libraries culibos and nvjpeg required for correct feature detection
    - if: linux and match(cuda_compiler_version, "13.*")
      then:
        - cuda-culibos-static
    - cuda-cudart-static
    - cuda-nvml-dev
    - libcufft-dev
    - libcufile-dev
    - libcurand-dev
    - libnpp-dev
    - libnvjpeg-dev
    - libnvjpeg-static
    - cuda-version ${{ cuda_compiler_version }}.*
    - aws-sdk-cpp
    - cfitsio
    - cutlass
    - dlpack
    - ffmpeg
    - ffmpeg * lgpl*
    - libabseil
    - libboost-headers  ${{ libboost_headers }}
    - libjpeg-turbo
    - if: linux and aarch64 and arm_variant_type != "tegra"
      then:
        - libnvcomp-dev  ${{ libnvcomp }}
    - libnvimgcodec-dev  ${{ libnvimgcodec }}
    - libnvjpeg2k-dev  ${{ libnvjpeg2k }}
    - libopencv
    - libprotobuf
    - libprotobuf-static
    - libsndfile
    - libtar
    - libtiff
    - lmdb
    - nvtx-c
    - pip
    - protobuf
    - pybind11
    - python
    - python-clang
    - rapidjson
    - setuptools
    - zlib
    # Runtime deps from below, for stub generator
    - nvtx
    - makefun
    - astunparse ${{ astunparse }}
    - gast ${{ gast }}
    - six ${{ six }}
    - dm-tree ${{ dm_tree }}
    - packaging ${{ packaging }}
    # Stubs autoformat themselves
    - black  ${{ black }}
  run:
    - python
    - nvtx
    - makefun
    - astunparse ${{ astunparse }}
    - gast ${{ gast }}
    - six ${{ six }}
    - dm-tree ${{ dm_tree }}
    - packaging ${{ packaging }}
    - ${{ pin_compatible('cuda-version', lower_bound='x', upper_bound='x') }}
  run_constraints:
    # These packages are dlopen'd and are already constrained by cuda-version
    # FIXME: Consider a meta-package like "nvidia-dali-all" for convenience
    # - if: match(cuda_compiler_version, "12.*")
    #   then:
    #     - libcufft
    #     - libcufile
    #     - libnpp
    #     - libnvjpeg
    - libboost-headers  ${{ libboost_headers }}
    - if: linux and aarch64 and arm_variant_type != "tegra"
      then:
        - libnvcomp  ${{ libnvcomp }}
    - libnvimgcodec ${{ libnvimgcodec }}
tests:
  - requirements:
      run:
        - pip
        # Test that optional dependencies are co-installable
        - libcufft
        - libcufile
        - libnpp
        - libnvjpeg
        - libboost-headers
        - if: linux and aarch64 and arm_variant_type != "tegra"
          then:
            - libnvcomp
        - libnvimgcodec
    script:
      - pip check
      - python -c "import nvidia.dali"
      - tfrecord2idx --help
      - wds2idx --help
about:
  summary: A GPU-accelerated library for data loading and pre-processing to accelerate deep learning applications.
  description: |
    A GPU-accelerated library containing highly optimized building blocks and
    an execution engine for data processing to accelerate deep learning training
    and inference applications.
  license: Apache-2.0 AND BSD-3-Clause AND BSD-2-Clause
  license_file:
    - LICENSE
    - COPYRIGHT
    - Acknowledgements.txt  # Contains licenses for linked libraries
    - third_party/README.rst
  homepage: https://github.com/NVIDIA/dali
extra:
  recipe-maintainers:
    - conda-forge/cuda
    - isuruf
    - timkpaine
