schema_version: 1

context:
  name: "sam3"
  # sam3 claims version 0.1.0 but they don't really release anything on pypi
  # so we'll use the date of the git hash to version the package
  # We can't use the git hash because the solver would think they are beta / alpha versions
  # https://github.com/conda-forge/sam-2-feedstock/blob/main/recipe/meta.yaml#L4
  git_hash_date: "20251211"
  git_hash: "b26a5f330e05d321afb39d01d3d4881f258f65ff"
  version: 0.1.0.${{ git_hash_date }}
  python_min: "3.10"


package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: https://github.com/facebookresearch/sam3/archive/${{ git_hash }}.tar.gz
  sha256: 3ca3b1df87415961ac42167ad71edccd0ab4f920df1246454d5e6f67170ebd25
  patches:
    # Decord is simply unmaintained and the codepath doesn't really use
    # that much reuse of a single video instance
    # I (hmaarrfk) rewrote it in pyav
    - use_pyav_instead_of_decord.patch
    # triton seems to be only used in
    # sample_one_point_from_error_center
    # which doesn't seem to be used in any sam3 codepath
    # So i'm going to lazy import this to avoid the whole triton (and compiler)
    # requirement
    - 0001-Avoid-importing-triton-since-it-doesn-t-seem-used.patch
    # numpy and ftfy are pinned too hard in sam3
    - loosen_dependencies.patch

build:
  number: 0
  noarch: python
  script:
    - python -m pip install . -vv

requirements:
  host:
    - python ${{ python_min }}.*
    - setuptools
    - wheel
    - pip
  run:
    - python >=${{ python_min }}
    - timm >=1.0.17
    - numpy >=1.26
    - tqdm
    - ftfy >=6.1.1
    - regex
    - iopath >=0.1.10
    - typing_extensions
    - huggingface_hub
    - einops
    - pytorch
    - einops >=0.8.0
    # They use pycocotools's mask utils alot
    - pycocotools
    - psutil
    - av

tests:
  - python:
      imports:
        - sam3
      pip_check: true
      python_version: ${{ python_min }}.*
  - script:
      # Verify the BPE vocabulary asset is included in the package
      - test -f $PREFIX/lib/python*/site-packages/sam3/assets/bpe_simple_vocab_16e6.txt.gz

about:
  summary: "SAM 3: Segment Anything with Concepts"
  description: |
    SAM 3 is a unified foundation model for promptable segmentation in images and videos.
    It can detect, segment, and track objects using text or visual prompts such as points,
    boxes, and masks.
  license: LicenseRef-SAM
  license_file: LICENSE
  homepage: https://github.com/facebookresearch/sam3
  repository: https://github.com/facebookresearch/sam3
  documentation: https://ai.meta.com/sam3/


extra:
  recipe-maintainers:
    - giswqs
    - claydugo
