context:
  version: "6.32.8"

package:
  name: cppyy-cling
  version: ${{ version }}

source:
  url: https://pypi.org/packages/source/c/cppyy-cling/cppyy_cling-${{ version }}.tar.gz
  sha256: f51ea2e9bd1418c27d1fca3ba97e322ad660a5e18180aad2d17fb55db43a0b49
  patches:
    - patches/0001-Do-not-use-llvm-config-when-cross-compiling.patch
    - patches/0002-Allow-usage-of-pre-built-dictionary-and-rootmap-when.patch
    - patches/0003-make-sure-C-formatting-symbols-are-available-in-C.patch
    - patches/0004-Revert-system_dirs.diff.patch
    - patches/0005-clang-for-aarch64-does-not-support-march-native.patch
    - patches/0006-Fix-order-of-clang-libraries.patch
    - patches/0007-Remove-libLLVM.so-when-linking.patch
    - patches/0008-Prevent-constants-from-being-dropped-from-archives-d.patch
    - patches/0009-Add-missing-link-dependencies.patch
    - patches/0010-InterpreterCallbacks-is-polymorphic.patch
    - patches/0011-Do-not-invoke-cmake-in-setup.py-build-since-it-is-to.patch
    - patches/0012-Rely-on-patched-clangdev-in-conda-forge-to-detect-ma.patch
    - patches/0013-Use-CXX-to-invoke-compiler.patch
    - patches/0014-Do-not-invoke-llvm-tblgen-when-cross-compiling.patch

build:
  number: 0
  skip:
    - win
  python:
    entry_points:
      - cling-config = cppyy_backend._cling_config:main
      - genreflex = cppyy_backend._genreflex:main
      - rootcling = cppyy_backend._rootcling:main
      - cppyy-generator = cppyy_backend._cppyy_generator:main

requirements:
  build:
    - if: build_platform != target_platform
      then:
        - python
        - cross-python_${{ target_platform }}
    - ${{ compiler('cxx') }}
    - ${{ stdlib("c") }}
    - sed
    - cmake
    # We need a find that understand -name
    - findutils
    - if: unix
      then: make
  host:
    - libboost-headers
    - python
    - pip
    - setuptools
    - zlib
    # Upstream uses 6.32.8 but using a later patch release does not seem to cause any issues downstream
    - clangdev =16 root_632*
  run:
    # We need a C++ compiler at runtime to compile cppdef snippets and glue
    # code and also so that all the standard headers are available. We do not
    # need the exact compiler that was used during the build {{ compiler('cxx') }}
    # but just any functional C++ compiler.
    - cxx-compiler
    - python
    # cppyy-cling invokes clang 16 at runtime which is not compatible with recent libcxx headers,
    # so we need to force older headers since otherwise we get "Libc++ only supports Clang 18 and later" and compile errors
    - if: osx
      then: libcxx-devel <19

tests:
  - files:
      recipe:
        - test.h
    script:
      - rootcling -h
      - rootcling test.dict test.h
      - genreflex -h

about:
  license: BSD-3-Clause
  license_file: LICENSE.txt
  summary: A repackaging of Cling for Automatic Python-C++ Bindings
  description: |
    A repackaging of Cling, the interactive C++ interpreter, including C/C++
    wrappers that expose no further external headers or types.
  homepage: https://pypi.org/project/cppyy-cling
  repository: https://bitbucket.org/wlav/cppyy-backend/src/master/cling/
  documentation: http://cppyy.readthedocs.io/

extra:
  recipe-maintainers:
    - saraedum
    - isuruf
