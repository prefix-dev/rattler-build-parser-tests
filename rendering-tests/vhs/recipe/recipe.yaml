schema_version: 1

context:
  name: vhs
  version: "0.10.0"

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  - url: https://github.com/charmbracelet/${{ name }}/archive/refs/tags/v${{ version }}.tar.gz
    sha256: ae37fe7e52ade753f850ab81c7d5344f8e540ab6886f877bf5b613620c909893
    target_directory: src
  # https://github.com/mattn/go-localereader/issues/2
  - url: https://github.com/mattn/go-localereader/raw/master/LICENSE
    sha256: dceede03550621e65ec7b79fcba87cf6dbb9d31132a8ae71a8fe8ceec0af7da3

build:
  number: 1
  script:
    - mv LICENSE go-localereader-LICENSE
    - cd src
    - go-licenses save . --ignore github.com/mattn/go-localereader --save_path=../library_licenses
    - if: not win
      then: go build -v -o $PREFIX/bin/vhs -ldflags="-s -w -X main.Version=${{ version }}"
      else: go build -v -o %LIBRARY_BIN%\vhs.exe -ldflags="-s -w -X main.Version=${{ version }}"

requirements:
  build:
    - ${{ compiler('go-nocgo') }}
    - go-licenses
  run:
    - ffmpeg
    # ttyd is not available on those platforms yet
    # https://github.com/conda-forge/ttyd-feedstock/pull/23
    - if: not win and not (target_platform == 'linux-ppc64le')
      then:
        - ttyd

tests:
  - package_contents:
      bin:
        - vhs
      strict: true
  - script:
      - if: unix
        then: vhs --version | grep "vhs version ${{ version | replace('.', '\\.') }}"
        else: vhs --version

about:
  summary: Your CLI home video recorder
  license: MIT
  license_file:
    - src/LICENSE
    - library_licenses/
    - go-localereader-LICENSE
  homepage: https://github.com/charmbracelet/vhs
  repository: https://github.com/charmbracelet/vhs

extra:
  recipe-maintainers:
    - pavelzw
