schema_version: 1

context:
  python_min: 3.11
  name: ESMValCore
  version: "2.13.0"

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: https://pypi.org/packages/source/${{ name[0] }}/${{ name }}/${{ name|lower }}-${{ version }}.tar.gz
  sha256: 033f885d28fde8dc3b3724b1ca1acae7e9f75411e8daa155c041d952300d915b

build:
  # Increment the build number when building a new conda package of the same
  # esmvalcore version, reset to 0 when building a new version.
  # This is noarch but will fail on windows due to missing dependency esmpy.
  number: 0
  noarch: python
  script: ${{ PYTHON }} -m pip install . --no-deps -vv --no-build-isolation

requirements:
  host:
    - python ${{ python_min }}.*
    - git
    - pip !=21.3
    - pytest-runner
    - setuptools >=40.6.0
    - setuptools_scm >=6.2
  run:
    - python >=${{ python_min }}
    - aiohttp
    - cartopy
    - cf-units
    - cftime
    - dask >=2025
    - dask-jobqueue
    - distributed
    - esgf-pyclient >=0.3.1
    - esmpy
    - esmvaltool-sample-data
    - filelock
    - fiona
    - fire
    - geopy
    - humanfriendly
    - intake-esm
    - iris >=3.12.2
    - iris-esmf-regrid >=0.11.0
    - iris-grib >=0.20.0
    - isodate >=0.7.0
    - jinja2
    - libnetcdf !=4.9.1  # issues lots of HDF5 warnings
    - nc-time-axis
    - ncdata
    - nested-lookup
    - netcdf4
    - numpy !=1.24.3
    - packaging
    - pandas
    - pillow
    - prov
    - psutil
    - py-cordex
    - pybtex
    - python-stratify >=0.3
    - pyyaml
    - requests
    - rich
    - scipy >=1.6
    - shapely >=2.0.0
    - xarray
    - yamale
    - zarr >3

tests:
  - python:
      imports:
        - esmvalcore
        - esmvalcore.cmor
        - esmvalcore.cmor.check
        - esmvalcore.cmor.fix
        - esmvalcore.config
        - esmvalcore.dataset
        - esmvalcore.esgf
        - esmvalcore.exceptions
        - esmvalcore.experimental
        - esmvalcore.iris_helpers
        - esmvalcore.local
        - esmvalcore.preprocessor
      pip_check: true
      python_version: ${{ python_min }}.*
  - files:
      source:
        - tests
        - setup.cfg
    requirements:
      run:
        - esmvaltool-sample-data
        - flake8 >=7
        - mypy >=0.990
        - pip
        - pytest >6.0.0
        - pytest-cov >=2.10.1
        - pytest-env
        - pytest-html !=2.1.0
        - pytest-metadata >=1.5.1
        - pytest-mock
        - pytest-mypy
        - pytest-xdist
        - r-yaml
        - python ${{ python_min }}.*
    script:
      - pip install types-requests types-PyYAML
      - pytest -n 2 --ignore=run_test.py --ignore=tests/unit/documentation/
      - esmvaltool -- --help
      - esmvaltool version

about:
  license: Apache-2.0
  license_file: LICENSE
  summary: "ESMValCore: A community tool for pre-processing data from Earth system models in CMIP and running analysis scripts."
  description: "ESMValCore: A community tool for pre-processing data from Earth system models in CMIP and running analysis scripts."
  homepage: https://www.esmvaltool.org
  repository: https://github.com/ESMValGroup/ESMValCore
  documentation: https://esmvaltool.readthedocs.io/

extra:
  recipe-maintainers:
    - jlenh
    - ehogan
    - remi-kazeroni
    - bouweandela
    - nielsdrost
    - schlunma
    - sloosvel
    - valeriupredoi
    - zklaus
