# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json
schema_version: 1

context:
  version: "2.0.0"
  cov_fail_under: "66"
  cov_pytest: coverage run --source=pygls --parallel --branch -m pytest -vv --color=yes --tb=long
  python_check_max: "3.14"

recipe:
  name: pygls
  version: ${{ version }}

source:
  - url: https://pypi.org/packages/source/p/pygls/pygls-${{ version }}.tar.gz
    sha256: 99accd03de1ca76fe1e7e317f0968ebccf7b9955afed6e2e3e188606a20b4f07
    target_directory: dist
  - url: https://github.com/openlawlibrary/pygls/archive/refs/tags/v${{ version }}.tar.gz
    sha256: 33f28ac94aef0b40097f21205531ba35e95caf86fca4d553854d35ec964915f6
    target_directory: src

build:
  number: 0
  noarch: python

outputs:
  - package:
      name: pygls
    build:
      noarch: python
      script:
        - cd dist
        - ${{ PYTHON }} -m pip install . -vv --no-deps --no-build-isolation --disable-pip-version-check
    requirements:
      host:
        - pip
        - python ${{ python_min }}.*
        - poetry-core
      run:
        - attrs >=24.3.0
        - python >=${{ python_min }}
        - cattrs >=23.1.2
        - lsprotocol ==2025.0.0
      run_constraints:
        - websockets >=13.0
    tests:
      - python:
          imports: pygls
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*

  - package:
      name: pygls-with-ws
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("pygls", exact=True) }}
        - websockets
    tests:
      - python:
          imports: pygls
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
      - files:
          source:
            - src/tests/
            - src/examples/
            - src/pyproject.toml
        requirements:
          run:
            - coverage
            - pytest
            - pytest-asyncio
            - python ${{ python_min }}.*
        script:
          - cd src
          - ${{ cov_pytest }}
          - ${{ cov_pytest }} tests/e2e --lsp-transport tcp
          - ${{ cov_pytest }} tests/e2e --lsp-transport websockets
          - coverage combine
          - coverage report --show-missing --skip-covered --fail-under=${{ cov_fail_under }}

about:
  license: Apache-2.0
  license_file:
    - dist/LICENSE.txt
    - src/ThirdPartyNotices.txt
  summary: a pythonic generic language server (pronounced like "pie glass").
  homepage: https://pygls.readthedocs.io
  repository: https://github.com/openlawlibrary/pygls
  documentation: https://pygls.readthedocs.io
  description: |
    pygls (pronounced like "pie glass") is a pythonic generic implementation of
    the Language Server Protocol for use as a foundation for writing language
    servers using Python (e.g. Python, XML, etc.). It allows you to write your
    own language server in just a few lines of code.

extra:
  feedstock-name: pygls
  recipe-maintainers:
    - bollwyvl
