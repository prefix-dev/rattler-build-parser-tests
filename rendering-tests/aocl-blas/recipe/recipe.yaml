schema_version: 1

context:
  version: "5.2"

recipe:
  name: aocl-blas-lapack
  version: ${{ version }}

source:
  - url: https://github.com/amd/blis/archive/refs/tags/${{ version }}.tar.gz
    sha256: c553bd543eedc87920df9b82634ae4c02662145ed737f51fdf4c9bca5e588028
    target_directory: aoclblas
  - url: https://github.com/amd/libflame/archive/refs/tags/${{ version }}.tar.gz
    sha256: fb5fe5128f718050c9911443fcf7ed91b60538a40d57084ed0124bb91afabb9b
    target_directory: aocllapack
    patches:
      - fixlinkflags.patch
  - url: https://github.com/amd/aocl-utils/archive/refs/tags/${{ version }}.tar.gz
    sha256: db0d807170a6eb73fcccd720a65a3e3aa8a787ae656c46479f7d9b4e1f9ed08a
    target_directory: aoclutils

build:
  number: 0


outputs:
  - package:
      name: aocl-utils
      version: ${{ version }}
    build:
      script: build_aoclutils
      skip:
        - osx
    requirements:
      build:
        - ${{ stdlib("c") }}
        - ${{ compiler("c") }}
        - ${{ compiler("cxx") }}
        - ninja
        - cmake
    tests:
      - script:
          - if: unix
            then:
              - test -f $PREFIX/lib/libaoclutils${SHLIB_EXT}
              - test -f $PREFIX/include/alci/alci.h
          - if: win
            then:
              - if not exist %LIBRARY_INC%\\alci\\alci.h exit 1
              - if not exist %LIBRARY_BIN%\\libaoclutils.dll exit 1
              - if not exist %LIBRARY_LIB%\\libaoclutils.lib exit 1
  - package:
      name: aocl-blas
      version: ${{ version }}
    build:
      script: build_aoclblas
    requirements:
      build:
        - ${{ stdlib("c") }}
        - ${{ compiler("c") }}
        - ${{ compiler("cxx") }}
        - if: not win
          then: ${{ compiler("fortran") }}
        - if: not linux
          then: llvm-openmp
          else: libgomp
        - ninja
        - cmake
    tests:
      - script:
          - if: unix
            then:
              - test -f $PREFIX/lib/libblis-mt${SHLIB_EXT}
              - test -f $PREFIX/include/blis.h
          - if: win
            then:
              - if not exist %LIBRARY_INC%\\blis.h exit 1
              - if not exist %LIBRARY_BIN%\\AOCL-LibBlis-Win-MT-dll.dll exit 1
              - if not exist %LIBRARY_LIB%\\AOCL-LibBlis-Win-MT-dll.lib exit 1
  - package:
      name: aocl-lapack
      version: ${{ version }}
    build:
      script: build_aocllapack
      skip:
        - osx
    requirements:
      build:
        - ${{ stdlib("c") }}
        - ${{ compiler("c") }}
        - ${{ compiler("cxx") }}
        - if: not win
          then: ${{ compiler("fortran") }}
        - if: not linux
          then: llvm-openmp
          else: libgomp
        - ninja
        - cmake
      host:
        - ${{ pin_subpackage('aocl-utils', exact=True) }}
        - ${{ pin_subpackage('aocl-blas', exact=True) }}
      run:
        - ${{ pin_subpackage('aocl-utils', exact=True) }}
        - ${{ pin_subpackage('aocl-blas', exact=True) }}
    tests:
      - script:
          - if: unix
            then:
              - test -f $PREFIX/lib/libflame${SHLIB_EXT}
              - test -f $PREFIX/include/lapacke.h
              - test -f $PREFIX/include/lapack.h
              - test -f $PREFIX/lib/pkgconfig/flame.pc
          - if: win
            then:
              - if not exist %LIBRARY_BIN%\\AOCL-LibFlame-Win-MT-dll.dll exit 1
              - if not exist %LIBRARY_LIB%\\AOCL-LibFlame-Win-MT-dll.lib exit 1

about:
  license: BSD-3-Clause
  license_file: LICENSE
  summary: "AMD's fork of BLIS optimized for AMD processors."
  description: |
    AOCL-BLAS is AMD's optimized version of BLAS targeted for AMD EPYC and Ryzen CPUs.
  homepage: https://www.amd.com/en/developer/aocl/dense.html
  repository: https://github.com/amd/blis

extra:
  recipe-maintainers:
    - chillenb
  feedstock-name: aocl-blas
