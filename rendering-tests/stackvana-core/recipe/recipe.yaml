# LSST DM versions are prefixed with letters
#
#  - a weekly build is 'w_2018_50'
#  - a major release is 'v18_1'
#
# In order to play nice with conda, we take the following conventions
#
#  - for a weekly build 'w_2018_50', the conda version is '0.2018.50'
#  - for a major version 'v18_1_0', the conda version is '18.1.0'
#
context:
  name: stackvana-core
  version: "0.2026.3"
  raw_major_version: '${{ (version | split("."))[0] }}'
  raw_minor_version: '${{ (version | split("."))[1] }}'
  raw_patch_version: '${{ (version | split("."))[2] }}'
  patch_version: ${{ "_" + raw_patch_version if (raw_patch_version | length) == 2 else "_0"  + raw_patch_version }}
  weekly_dm_tag: ${{ "w_" + raw_minor_version + patch_version }}
  non_weekly_dm_tag: ${{ "v" + (version | replace(".", "_")) }}
  dm_tag: ${{ weekly_dm_tag if raw_major_version == '0' else non_weekly_dm_tag }}

recipe:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: https://eups.lsst.cloud/stack/src/tags/${{ dm_tag }}.list
  sha256: 234fb8445554574cfcefabc1ddf79f3434d7998d82eaff5f38f853bb2ed1c559

build:
  skip:
    - win
    - match(python, "!=${{ lsst_pyver }}")
  number: 0
  merge_build_and_host_envs: true

outputs:
  - package:
      name: stackvana-core

    requirements:
      host:
        - python
      run:
        - python
        - ${{ pin_subpackage('stackvana-core-impl', exact=True) }}
      run_exports:
        - ${{ pin_subpackage('stackvana-core-impl', exact=True) }}

    tests:
      - script:
          - eups -h
          - eups list
          - if [[ ! ${STACKVANA_ACTIVATED} ]]; then exit 1; fi

  - package:
      name: stackvana-core-impl

    build:
      script:
        file: build_impl.sh
        env:
          LSST_PYVER: ${{ lsst_pyver }}

    requirements:
      host:
        # these pins are here so we get the proper run exports
        # but defer the versions to rubin-env
        - ${{ c_compiler }}_${{ target_platform }} *
        - ${{ cxx_compiler }}_${{ target_platform }} *
        - ${{ fortran_compiler }}_${{ target_platform }} *
        - ${{ rust_compiler }}_${{ target_platform }} *
        - ${{ stdlib('c') }}
        - if: osx
          then: llvm-openmp
        - if: linux
          then: libgomp
        - python
        - rubin-env-nosysroot =${{ rubin_env }}
      run:
        - python
        - ${{ pin_compatible('rubin-env-nosysroot', upper_bound='x') }}

    tests:
      - script: run_test_impl.sh
        requirements:
          run:
            - python
            - rubin-env-nosysroot =${{ rubin_env }}
            - micromamba

about:
  homepage: https://github.com/beckermr/stackvana-core
  license: GPL-3.0-or-later
  license_file:
    - LICENSE
    - COPYRIGHT
  summary: core build tooling for stackvana

extra:
  recipe-maintainers:
    - beckermr
