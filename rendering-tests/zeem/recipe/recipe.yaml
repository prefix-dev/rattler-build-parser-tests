context:
  name: "zeem"
  version: "2.1.0"
  author: "mhekkel"

package:
  name: zeem
  version: ${{ version }}

source:
  url: https://github.com/${{ author }}/${{ name }}/archive/refs/tags/v${{ version }}.tar.gz
  sha256: 8b7998cc732f3220f57bfd9d01964e5aa005bc1288f0c9eee25d38a71c1eb0eb

build:
  number: 3
  script:
    # Use locally installed Catch2
    - sed -i.bak 's#CPMAddPackage("gh:catchorg/Catch2@3.4.0")#find_package(Catch2 REQUIRED)#' test/CMakeLists.txt

    - if: unix
      then: |
        set -exo pipefail
        
        export CXXFLAGS="${CXXFLAGS} -D_LIBCPP_DISABLE_AVAILABILITY"
        
        if [[ ${build_platform} != ${target_platform} ]]; then
          extra_cmake_args="-DTEST_STD_CHRONO_FROM_STREAM_R=ON -DCMAKE_CROSSCOMPILING=ON"
        fi

        # Skip tests for cross compilation for macos
        if [[ ${build_platform} != ${target_platform} && ${target_platform} == "osx-arm64" ]]; then
          cmake -S . -B build ${CMAKE_ARGS} -DBUILD_TESTING=OFF -DBUILD_SHARED_LIBS=ON
        else
          cmake -S . -B build ${CMAKE_ARGS} -DBUILD_TESTING=ON -DBUILD_SHARED_LIBS=ON ${extra_cmake_args}
        fi

        cmake --build build --config Release --parallel ${CPU_COUNT}
        ctest -V -C Release --test-dir build
        cmake --install build
    - if: win
      then: |
        @echo on
        set PATH=%SRC_DIR%\build;%SRC_DIR%\build\bin;%SRC_DIR%\build\Release;%SRC_DIR%\build\release;%PATH%
        if errorlevel 1 exit 1
        cmake -S . -B build -G "NMake Makefiles JOM" %CMAKE_ARGS% -DCMAKE_WINDOWS_EXPORT_ALL_SYMBOLS=ON -DBUILD_TESTING=ON -DBUILD_SHARED_LIBS=ON
        if errorlevel 1 exit 1
        cmake --build build --config Release --parallel %CPU_COUNT%
        if errorlevel 1 exit 1
        ctest -V -C Release --test-dir build
        if errorlevel 1 exit 1
        cmake --install build
        if errorlevel 1 exit 1

requirements:
  build:
    - ${{ compiler("cxx") }}
    - ${{ stdlib("c") }}
    - cmake
    - if: unix
      then: make
    - pkg-config
    - if: win
      then:
        - jom
        - m2-sed
  host:
    - catch2
    - fast_float
    - howardhinnant_date
  run_exports:
    # Patch version update may be breakable
    - ${{ pin_subpackage(name, upper_bound="x.x.x") }}
  ignore_run_exports:
    from_package: catch2

tests:
  - script:
      - if: unix
        then: |
          test -d ${PREFIX}/include/zeem
          test -f ${PREFIX}/lib/libzeem${SHLIB_EXT}
        else: |
          if not exist "%LIBRARY_PREFIX%\include\zeem\" exit /b 1
          if not exist "%LIBRARY_PREFIX%\lib\zeem.lib" exit /b 1
          if not exist "%LIBRARY_PREFIX%\bin\zeem.dll" exit /b 1

about:
  homepage: https://mhekkel.github.io/zeem
  repository: https://github.com/mhekkel/zeem
  documentation: https://mhekkel.github.io/zeem
  license: BSD-2-Clause
  license_file: LICENSE
  summary: "A C++ Module Library offering a full XML library with validating parser, DOM tree, XPaths and serialization."
  description: >
    This is a feature complete XML library containing a validating parser as well as a modern C++ API for the data structures.
    It also supports serializing custom data structures.

    The core of this library is a validating XML parser with DTD processing and all.
    On top of this are implemented an API for manipulating XML data in a DOM like fashion and a serialization API.
    As a bonus thereâ€™s also an XPath implementation, albeit this is limited to XPath 1.0.

    This XML library was extracted from [libzeep](https://github.com/mhekkel/libzeep) since having a separate and simple XML library is more convenient.
    The API is unfortunately no longer compatible since the goal was to be more standards compliant.
    E.g., zeem::element should now be a complete [Sequence Container](https://en.cppreference.com/w/cpp/named_req/SequenceContainer).

extra:
  recipe-maintainers:
    - eunos-1128
