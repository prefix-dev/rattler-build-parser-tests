From 4dacf04e9333ecf89bacd6d1713a181a3bdffb12 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Fri, 22 Aug 2025 06:03:21 +0200
Subject: [PATCH 1/3] feat: Make tracebacks involving _patch_module more
 readable by including file path

---
 crossenv/scripts/site.py.tmpl | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/crossenv/scripts/site.py.tmpl b/crossenv/scripts/site.py.tmpl
index 7b691cf..2ab6e47 100644
--- a/crossenv/scripts/site.py.tmpl
+++ b/crossenv/scripts/site.py.tmpl
@@ -52,7 +52,8 @@ def _patch_module(module, patch):
     # The default causes an import to happen too early.
     with open(patch, 'r', encoding='utf-8') as fp:
         src = fp.read()
-    exec(src, module.__dict__, module.__dict__)
+    code = compile(src, patch, 'exec')
+    exec(code, module.__dict__, module.__dict__)
     module.__patched__ = True
 
 def make_loader(original, patch):

From 3e7f2e99496b8310490d68079c2621871767c837 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Fri, 22 Aug 2025 06:09:36 +0200
Subject: [PATCH 2/3] fix: Use posix.uname_result rather than making a named
 tuple

In Python 3.14 the combination of crossenv's patching and the import of collections.namedtuple results in a loop in the import machinery:

Fatal Python error: init_import_site: Failed to import the site module
Python runtime state: initialized
Traceback (most recent call last):
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/site.py", line 177, in <module>
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/site.py", line 122, in __init__
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/site.py", line 170, in manually_patch_loaded
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/site.py", line 56, in _patch_module
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/os-patch.py", line 1, in <module>
  File "<frozen importlib._bootstrap>", line 1371, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1333, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 1267, in _find_spec
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/importlib-machinery-patch.py", line 18, in _PathFinder_find_spec
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 507, in get_path
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 497, in get_paths
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 276, in _expand_vars
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 625, in get_config_vars
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 525, in _init_config_vars
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 393, in _init_posix
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 373, in _get_sysconfigdata
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/importlib/__init__.py", line 88, in import_module
  File "<frozen importlib._bootstrap>", line 1398, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1371, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1333, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 1267, in _find_spec
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/importlib-machinery-patch.py", line 18, in _PathFinder_find_spec
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 507, in get_path
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 497, in get_paths
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 286, in _expand_vars
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 262, in _subst_vars
AttributeError: 'installed_base'
---
 crossenv/scripts/os-patch.py.tmpl | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/crossenv/scripts/os-patch.py.tmpl b/crossenv/scripts/os-patch.py.tmpl
index 6503ca7..c0acf56 100644
--- a/crossenv/scripts/os-patch.py.tmpl
+++ b/crossenv/scripts/os-patch.py.tmpl
@@ -1,14 +1,12 @@
-from collections import namedtuple
+import posix
 
 # Fixup os.uname, which should fix most of platform module
-uname_result_type = namedtuple('uname_result',
-        'sysname nodename release version machine')
-_uname_result = uname_result_type(
+_uname_result = posix.uname_result((
         {{repr(self.host_sysname)}},
         'build',
         {{repr(self.host_release)}},
         '',
-        {{repr(self.host_machine)}})
+        {{repr(self.host_machine)}}))
 
 def uname():
     return _uname_result

From 21dbd981ad594941bd39ed278e0e927c80ff89b5 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Fri, 22 Aug 2025 06:12:38 +0200
Subject: [PATCH 3/3] fix: Don't pass any argument to is_python_build due to
 deprecation since Python 3.12

See here for the deprecation: https://github.com/python/cpython/commit/067597522a9002f3b8aff7f46033f10acb2381e4#diff-d593bd299ba58e440ba411ffa0640ccd9d20d518b0cf2644ed4bdb75a82a3e70

The argument is removed in Python 3.15 and in Python 3.14 the import of warnings results in a loop in the import machinery (similar to 3e7f2e9):

Fatal Python error: init_import_site: Failed to import the site module
Python runtime state: initialized
Traceback (most recent call last):
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/site.py", line 177, in <module>
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/site.py", line 122, in __init__
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/site.py", line 170, in manually_patch_loaded
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/site.py", line 56, in _patch_module
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/sysconfig-patch.py", line 5, in <module>
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 225, in is_python_build
  File "<frozen importlib._bootstrap>", line 1371, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1333, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 1267, in _find_spec
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/importlib-machinery-patch.py", line 18, in _PathFinder_find_spec
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 507, in get_path
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 497, in get_paths
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 276, in _expand_vars
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 625, in get_config_vars
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 525, in _init_config_vars
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 393, in _init_posix
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 373, in _get_sysconfigdata
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/importlib/__init__.py", line 88, in import_module
  File "<frozen importlib._bootstrap>", line 1398, in _gcd_import
  File "<frozen importlib._bootstrap>", line 1371, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1333, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 1267, in _find_spec
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/venv/lib/importlib-machinery-patch.py", line 18, in _PathFinder_find_spec
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 507, in get_path
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 497, in get_paths
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 286, in _expand_vars
  File "/home/cburr/Development/conda-forge/pycurl-feedstock/output/bld/rattler-build_pycurl_1755835374/build_env/lib/python3.14/sysconfig/__init__.py", line 262, in _subst_vars
AttributeError: 'installed_base'
---
 crossenv/scripts/sysconfig-patch.py.tmpl | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/crossenv/scripts/sysconfig-patch.py.tmpl b/crossenv/scripts/sysconfig-patch.py.tmpl
index 189b917..f736f9d 100644
--- a/crossenv/scripts/sysconfig-patch.py.tmpl
+++ b/crossenv/scripts/sysconfig-patch.py.tmpl
@@ -3,7 +3,10 @@
 _PROJECT_BASE = {{repr(self.host_project_base)}}
 
 # Things that need to be re-evaluated after patching
-_PYTHON_BUILD = is_python_build(True)
+if sys.version_info[:2] < (3, 12):
+    _PYTHON_BUILD = is_python_build(True)
+else:
+    _PYTHON_BUILD = is_python_build()
 _PREFIX = os.path.normpath(sys.prefix)
 _BASE_PREFIX = os.path.normpath(sys.base_prefix)
 _EXEC_PREFIX = os.path.normpath(sys.exec_prefix)
