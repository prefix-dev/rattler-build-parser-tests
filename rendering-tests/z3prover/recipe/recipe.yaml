schema_version: 1

context:
  version: "4.15.4"
  # the last non-0 micro version was 4.4.2.1 in 2016
  version_with_py_micro: "${{ version }}.0"
  lib: ${{ "" if unix else "Library/" }}
  python_check_max: "3.14"

recipe:
  name: z3prover
  version: ${{ version }}

source:
  url: https://github.com/Z3Prover/z3/archive/refs/tags/z3-${{ version }}.tar.gz
  sha256: dae526252cb0585c8c863292ebec84cace4901a014b190a73f14087dd08d252b
  patches:
    # backport https://github.com/Z3Prover/z3/pull/8088
    - patches/0001-BLD-Add-CMake-option-to-build-Python-bindings-withou.patch
    - patches/0002-avoid-custom-re-build-commands-and-data-files.patch

build:
  number: 3

outputs:
  - package:
      name: libz3
    build:
      script:
        - build_lib
    requirements:
      build:
        - if: build_platform != host_platform
          then:
            - cross-python_${{ host_platform }}
        # even for native builds, so we can uniformly use
        # -DPython3_EXECUTABLE=${BUILD_PREFIX}/bin/python in build_py.sh
        - python *
        - ${{ stdlib('c') }}
        - ${{ compiler('cxx') }}
        - cmake
        - ninja
        - if: linux
          then: libgomp
          else: llvm-openmp
      host:
        - python *
        - if: linux
          then: libgomp
          else: llvm-openmp
      ignore_run_exports:
        by_name:
          - python
          - python_abi
      run_exports:
        - ${{ pin_subpackage("libz3", upper_bound='x') }}
      run_constraints:
        - z3prover ==${{ version }}

    tests:
      - package_contents:
          files:
            # libraries
            - if: linux
              then:
                - lib/libz3.so
                - lib/libz3.so.${{ version }}*
            - if: osx
              then:
                - lib/libz3.dylib
                - lib/libz3.${{ version }}*.dylib
            - if: win
              then:
                - Library/bin/libz3.dll
                - Library/lib/libz3.lib
            # binaries
            - if: unix
              then:
                - bin/z3
              else:
                - Library/bin/z3.exe
            # headers
            - ${{ lib }}include/z3_algebraic.h
            - ${{ lib }}include/z3_api.h
            - ${{ lib }}include/z3_ast_containers.h
            - ${{ lib }}include/z3_fixedpoint.h
            - ${{ lib }}include/z3_fpa.h
            - ${{ lib }}include/z3.h
            - ${{ lib }}include/z3++.h
            - ${{ lib }}include/z3_macros.h
            - ${{ lib }}include/z3_optimization.h
            - ${{ lib }}include/z3_polynomial.h
            - ${{ lib }}include/z3_rcf.h
            - ${{ lib }}include/z3_v1.h
            - ${{ lib }}include/z3_spacer.h
            - ${{ lib }}include/z3_version.h
            # cmake & pkgconfig metadata
            - ${{ lib }}lib/cmake/z3/Z3Targets.cmake
            - ${{ lib }}lib/cmake/z3/Z3Targets-release.cmake
            - ${{ lib }}lib/cmake/z3/Z3Config.cmake
            - ${{ lib }}lib/cmake/z3/Z3ConfigVersion.cmake
            - ${{ lib }}lib/pkgconfig/z3.pc
      - script:
          - z3 --help

  - package:
      name: z3-solver
      version: ${{ version_with_py_micro }}
    build:
      skip: not is_python_min
      python:
        version_independent: true
      script:
        file: build_py
    requirements:
      build:
        - if: build_platform != host_platform
          then:
            - cross-python_${{ host_platform }}
        # even for native builds, so we can uniformly use
        # -DPython3_EXECUTABLE=${BUILD_PREFIX}/bin/python in build_py.sh
        - python ${{ python_min }}.*
        - ${{ stdlib('c') }}
        - ${{ compiler('cxx') }}
        - cmake
        - ninja
        - if: linux
          then: libgomp
          else: llvm-openmp
      host:
        - ${{ pin_subpackage("libz3", exact=True) }}
        - python ${{ python_min }}.*
        - setuptools
        - pip
        - if: linux
          then: libgomp
          else: llvm-openmp
      run:
        - ${{ pin_subpackage("libz3", exact=True) }}
        - python >=${{ python_min }}
    tests:
      - package_contents:
          site_packages:
            - z3_solver-${{ version_with_py_micro }}.dist-info/METADATA
      - python:
          imports:
            - z3
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
      - files:
          recipe:
            - test_z3.py
        requirements:
          run:
            - pytest
            - python !=${{ python_min }}.*
        script:
          - pytest -vv --tb=long --color=yes

  - package:
      # compatibility for previous name of library
      name: z3prover
    requirements:
      host:
        - ${{ pin_subpackage("libz3", exact=True) }}
      run:
        - ${{ pin_subpackage("libz3", exact=True) }}
      run_exports:
        - ${{ pin_subpackage("libz3", upper_bound='x') }}
    tests:
      - script:
          - z3 --help

about:
  license: MIT
  license_file: LICENSE.txt
  summary: The Z3 Theorem Prover
  homepage: https://github.com/Z3Prover/z3
  repository: https://github.com/Z3Prover/z3
  documentation: https://github.com/Z3Prover/z3/wiki#background

extra:
  recipe-maintainers:
    - martin-g
    - h-vetinari
