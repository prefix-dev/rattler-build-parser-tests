# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json
schema_version: 1

# this recipe is kind of heavy: see this script for more automation
# https://gist.github.com/bollwyvl/d6041fcf86348ca719cf925b6d045aca

context:
  version: "2.42.6"
  python_check_max: "3.14"
  locust_cloud_min: "1.29.4"

recipe:
  name: locust-split
  version: ${{ version }}

source:
  - url: https://pypi.org/packages/source/l/locust/locust-${{ version }}.tar.gz
    sha256: fa603f4ac1c48b9ac56f4c34355944ebfd92590f4197b6d126ea216bd81cc036
    target_directory: dist
  - url: https://github.com/locustio/locust/archive/refs/tags/${{ version }}.tar.gz
    sha256: d6db4afd9f6a398d22b928ed5311070afba1471cf8353622a4e1c94fcec38571
    target_directory: src

build:
  number: 0
  noarch: python

outputs:
  - package:
      name: locust
    build:
      noarch: python
      script:
        env:
          SKIP_PRE_BUILD: 'true'
          LOCUST_CLOUD_MIN: ${{ locust_cloud_min }}
        content:
          - ${{ PYTHON }} ${{ RECIPE_DIR }}/patch-locust-cloud.py
          - cd dist
          - ${{ PYTHON }} -m pip install . -vv --no-deps --no-build-isolation --disable-pip-version-check
      python:
        entry_points:
          - locust = locust.main:main
    requirements:
      host:
        - hatch-vcs
        - hatchling
        - pip
        - python ${{ python_min }}.*
      run:
        - configargparse >=1.7.1
        - flask >=2.0.0
        - flask-cors >=3.0.10
        - flask-login >=0.6.3
        - gevent >=24.10.1,<26.0.0,!=25.8.1
        - geventhttpclient >=2.3.1
        - msgpack-python >=1.0.0
        - psutil >=5.9.1
        - pytest >=8.3.3,<10
        - python >=${{ python_min }}
        - python-engineio >=4.12.2
        - python-socketio >=5.13.0
        - pywin32-on-windows
        - pyzmq >=25.0.0
        - requests >=2.32.2,<2.32.5
        - tomli >=1.1.0
        - typing_extensions >=4.6.0
        - werkzeug >=2.0.0
      run_constraints:
        - locust-cloud >=${{ locust_cloud_min }}
    tests:
      - python:
          imports: locust
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
      - requirements:
          run:
            - python ${{ python_min }}.*
        script:
          - locust --version
          - locust --help
  - package:
      name: locust-with-milvus
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("locust", exact=True) }}
        - pymilvus >=2.5.0
    tests:
      - python:
          imports: locust
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
    about:
      summary: Website load testing framework (with [milvus])
      license: MIT
      license_file: dist/LICENSE
  - package:
      name: locust-with-mqtt
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("locust", exact=True) }}
        - paho-mqtt >=2.1.0
    tests:
      - python:
          imports: locust
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
    about:
      summary: Website load testing framework (with [mqtt])
      license: MIT
      license_file: dist/LICENSE
  - package:
      name: locust-with-dns
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("locust", exact=True) }}
        - dnspython >=2.8.0
    tests:
      - python:
          imports: locust
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
    about:
      summary: Website load testing framework (with [dns])
      license: MIT
      license_file: dist/LICENSE
  - package:
      name: locust-with-otel
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("locust", exact=True) }}
        - opentelemetry-exporter-otlp-proto-grpc >=1.38.0
        - opentelemetry-exporter-otlp-proto-http >=1.38.0
        - opentelemetry-instrumentation-requests >=0.59b0
        - opentelemetry-instrumentation-urllib3 >=0.59b0
        - opentelemetry-sdk >=1.38.0
    tests:
      - python:
          imports: locust
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
    about:
      summary: Website load testing framework (with [otel])
      license: MIT
      license_file: dist/LICENSE
  - package:
      name: locust-with-all
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("locust", exact=True) }}
        - ${{ pin_subpackage("locust-with-dns", exact=True) }}
        - ${{ pin_subpackage("locust-with-milvus", exact=True) }}
        - ${{ pin_subpackage("locust-with-mqtt", exact=True) }}
        - ${{ pin_subpackage("locust-with-otel", exact=True) }}
    tests:
      - python:
          imports: locust
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
      - files:
          source:
            - src/locust/test/
        requirements:
          run:
            - cryptography
            - pyquery >=2.0.0,<3.0.0
            - pytest-cov
            - python ${{ python_min }}.*
            - retry >=0.9.2,<1.0.0
        script:
          file: run_test.py
    about:
      summary: Website load testing framework (with [all])
      license: MIT
      license_file: dist/LICENSE
about:
  license: MIT
  license_file: dist/LICENSE
  summary: Website load testing framework
  homepage: https://locust.io
  repository: https://github.com/locustio/locust
  documentation: https://docs.locust.io
  description: |
    Locust is an easy-to-use, distributed, user load testing tool. It is
    intended for load-testing web sites (or other systems) and figuring out how
    many concurrent users a system can handle.

extra:
  feedstock name: locust
  recipe-maintainers:
    - carlodri
    - bollwyvl
