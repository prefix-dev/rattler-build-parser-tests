context:
  name: arrow-odbc
  version: 9.3.3
  build: 3

recipe:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  url: https://pypi.org/packages/source/${{ name[0] }}/${{ name }}/${{ name | replace("-", "_") }}-${{ version }}.tar.gz
  sha256: 31d4bdf0070a8e05371700a9794db3500e7548e6779a4477f2ef241d0c70a052

build:
  number: ${{ build }}

outputs:
  - package:
      name: ${{ name }}
      version: ${{ version }}
    build:
      number: ${{ build }}
      script:
        env:
          CARGO_PROFILE_RELEASE_STRIP: symbols
          CARGO_PROFILE_RELEASE_LTO: fat
        content:
          - if: unix
            then:
              - export RUSTFLAGS="-Clink-args=-Wl,-L$PREFIX/lib"
          - ${{ PYTHON }} -m pip install --no-deps --no-build-isolation .
          - cargo-bundle-licenses --format yaml --output THIRDPARTY.yml
    requirements:
      build:
        - if: build_platform != target_platform
          then:
            - maturin >=1,<2
            - cffi
            - python
            - cross-python_${{ target_platform }}
            - crossenv
        - ${{ compiler('c') }}
        - ${{ stdlib('c') }}
        - ${{ compiler('rust') }}
        - cargo-bundle-licenses
      host:
        - python
        - cffi
        - maturin >=1,<2
        - pip
        - pyarrow >=8
        - if: unix
          then:
            - unixodbc
        - if: osx
          then:
            - libiconv
      run:
        - python
        - cffi
        - pyarrow >=8
    tests:
      - python:
          imports:
            - arrow_odbc
          pip_check: true
  - package:
      name: ${{ name | replace("-", "_") }}
    build:
      noarch: generic
      number: ${{ build }}
      skip:
        - not target_platform == "linux-64"
    requirements:
      run:
        - ${{ pin_subpackage(name, lower_bound="x.x.x", upper_bound="x.x.x") }}
    about:
      license_file: []
    tests:
      - python:
          imports:
            - arrow_odbc
          pip_check: true

about:
  homepage: https://github.com/pacman82/arrow-odbc-py
  repository: https://github.com/pacman82/arrow-odbc-py
  license: MIT
  license_file:
    - LICENSE
    - THIRDPARTY.yml
  summary: Read Apache Arrow batches from ODBC data sources in Python

extra:
  recipe-maintainers:
    - jonashaag
    - timkpaine
    - pacman82
    - pavelzw
